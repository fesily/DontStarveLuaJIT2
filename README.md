[English](README_EN.md)

# DontStarveLuaJIT

	Don't Starve LuaJIT ä¼˜åŒ–è¡¥ä¸

  QQç¾¤: 348368954

## æ³¨æ„

è¯·åŠ¡å¿…å¤‡ä»½æ‚¨çš„å­˜æ¡£ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä¿è¯æ’ä»¶ä¸ä¼šå¯¼è‡´å­˜æ¡£æŸåï¼
ä½¿ç”¨ä¸“ç”¨æœåŠ¡å™¨å¼€æœéœ€è¦æ³¨æ„ï¼Œè®¾ç½®ä¸­`æœåŠ¡å™¨ç¦ç”¨luajit`é€‰é¡¹æ˜¯æ— æ•ˆçš„ï¼Œä½ åº”è¯¥ç›´æ¥å¸è½½luajitå†å¯åŠ¨æœåŠ¡å™¨

# è®¡åˆ’

## Don't Starve Together

- [x] windows x64
- [x] ~~windows x86~~
- [x] linux x64
- [x] ~~linux x86~~
- [x] macos
- [ ] andorid
- [ ] switch

## Don't Starve

- [ ] windows x64
- [ ] ~~windows x86~~
- [ ] linux
- [ ] macos
- [ ] andorid
- [ ] switch

## å®Œå…¨å…¼å®¹åŠ å¯†mod

åŠŸèƒ½æè¿°:

å®Œå…¨è§£å†³åŠ å¯†modä¸å…¼å®¹luajitçš„é—®é¢˜,é™¤éä»£ç ä¾èµ–äº†luaè¯­è¨€çš„æœªå®šä¹‰è¡Œä¸º

èµåŠ©:
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ (436/500)

## åŠ å¯†æ’ä»¶

åŠŸèƒ½æè¿°:

ä¸æŸå¤±ä»»ä½•æ€§èƒ½åœ°åŠ å¯†mod,åŠ å¯†åä»…èƒ½åœ¨luajitä¸Šè¿è¡Œ

## å¤šçº¿ç¨‹å¹¶å‘GCæ’ä»¶

åŠŸèƒ½æè¿°:

é¢„è®¡å‡å°‘å¡é¡¿æƒ…å†µ.(ps: é¢„è®¡ä½ æ‡‚çš„ğŸ˜„)

æå¤§å‡å°‘stopworldæ—¶é—´,å‡å°‘é€»è¾‘å¸§è¿‡é•¿å¯¼è‡´çš„å¡é¡¿

èµåŠ©:
â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ (0/500)

## Nintendo switchæ’ä»¶

åŠŸèƒ½æè¿°:

æ”¯æŒpcç©å®¶è·¨å¹³å°æ¸¸æˆ.(ps: ğŸ«“)


# å®‰è£…ï¼š

## 1.MODæœ¬ä½“ï¼š

1. å…ˆåœ¨æ¸¸æˆæ ¹ç›®å½•ä¸‹çš„modsæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹ï¼Œåå­—éšæ„å–ï¼Œæ¯”å¦‚`Luajit`
2. ç„¶åæŠŠæ‰€æœ‰çš„æ–‡ä»¶å¤åˆ¶åˆ°è¯¥ç›®å½•

## 2.æ³¨å…¥éƒ¨åˆ†ï¼š

### æ–¹æ³• 1ï¼ˆè‡ªåŠ¨å®‰è£…ï¼‰
- ç›´æ¥è¿è¡ŒLuajitæ–‡ä»¶å¤¹å†…çš„`install.bat` (Windowsç³»ç»Ÿ) / `install_linux.sh` (Linuxç³»ç»Ÿ)
- è¿è¡Œ`install_linux.sh`å‰å¯èƒ½éœ€è¦å…ˆæ‰§è¡Œ`chmod +x ./install_linux.sh`èµ‹äºˆæƒé™

### æ–¹æ³• 2ï¼ˆæ‰‹åŠ¨å®‰è£…ï¼‰

#### Windows

- å°† `Luajit/bin64/windows` æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶`å¤åˆ¶`åˆ°`æ¸¸æˆç›®å½•`ä¸‹çš„ `bin64` æ–‡ä»¶å¤¹ä¸­
- æ¯”å¦‚ D:\Steam\steamapps\common\Don't Starve Together\bin64
- ä¸“ç”¨æœåŠ¡å™¨åŒç†

#### Linux

æˆ‘åªåœ¨ ubuntu ä¸Šæµ‹è¯•è¿‡ï¼Œä½†å¦‚æœæœ‰äººèƒ½æä¾› steamos ç¯å¢ƒï¼Œæˆ‘ä¹Ÿå¯ä»¥åœ¨ steamos ä¸Šæµ‹è¯•ï¼Œå“ˆå“ˆï¼

- å°† `Luajit/bin64/linux` æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶`å¤åˆ¶`åˆ°`æ¸¸æˆç›®å½•`ä¸‹çš„ `bin64`æ–‡ä»¶å¤¹ä¸­
- å°†åŸå§‹æ¸¸æˆå¯æ‰§è¡Œæ–‡ä»¶ `dontstarve_steam_x64` é‡å‘½åä¸º `dontstarve_steam_x64_1`
- åˆ›å»ºå†…å®¹ä¸º `dontstarve_steam_x64` çš„æ–°æ–‡ä»¶ï¼š

```bash
#!/bin/bash
export LD_LIBRARY_PATH=./lib64
export LD_PRELOAD=./lib64/libInjector.so
./dontstarve_steam_x64_1 "$@"
```

- è¿è¡Œ shell `chmod +x ./dontstarve_steam_x64`
- æå®š

- ä¸“ç”¨æœåŠ¡å™¨æ–‡ä»¶åä¸º`dontstarve_dedicated_server_nullrenderer_x64`ï¼Œè¯·è‡ªè¡Œæ›¿æ¢ç›¸å…³å†…å®¹

#### Macos

- åˆ›å»ºä¸€ä¸ªå±äºè‡ªå·±çš„è¯ä¹¦ï¼Œæ¯”å¦‚åå­—ä¸ºDontstarve

  [å®˜æ–¹æ•™ç¨‹](https://support.apple.com/zh-cn/guide/keychain-access/kyca8916/mac)

- æ‰“å¼€shell
- åˆ‡æ¢åˆ°è‡ªå·±çš„æ¸¸æˆè·¯å¾„

  `cd /Users/*/Library/Application Support/Steam/steamapps/common/Don't Starve Together/dontstarve_steam.app`

- `sudo codesign -fs Dontstarve ./dontstarve_steam.app`
- åˆ›å»ºä¸€ä¸ªæ–°çš„æƒé™ç®¡ç†æ–‡ä»¶ï¼Œæ¯”å¦‚å«`my.xml`ï¼Œå†…å®¹ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "https://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
    <dict>
        <key>com.apple.security.cs.allow-dyld-environment-variables</key>
        <true/>
        <key>com.apple.security.cs.disable-library-validation</key>
        <true/>
        <key>com.apple.security.get-task-allow</key>
        <true/>
    </dict>
</plist>
```

- `sudo codesign -d --entitlements ./my.xml ./dontstarve_steam.app`
- å°† `Luajit/bin64/osx` æ–‡ä»¶å¤¹å†…æ‰€æœ‰æ–‡ä»¶`å¤åˆ¶`åˆ°`æ¸¸æˆç›®å½•`ä¸‹çš„ `MacOS`æ–‡ä»¶å¤¹ä¸­
- å°†åŸå§‹æ¸¸æˆå¯æ‰§è¡Œæ–‡ä»¶ `dontstarve_steam` é‡å‘½åä¸º `dontstarve_steam_1`
- åˆ›å»ºå†…å®¹ä¸º `dontstarve_steam` çš„æ–°æ–‡ä»¶ï¼š

```bash
#!/bin/bash
export DYLD_INSERT_LIBRARIES=./libInjector.dylib
./dontstarve_steam_1
```

- è¿è¡Œ shell `chmod +x ./dontstarve_steam`

## 3.å¯ç”¨mod

åœ¨æ¸¸æˆä¸­å¯ç”¨åä¸ºdontstarveluajit2çš„mod

å¦‚æœæ²¡æœ‰ä»»ä½•å…¶ä»–é—®é¢˜ï¼Œåº”è¯¥å¯ä»¥åœ¨å³ä¸‹è§’çš„ç‰ˆæœ¬å·çœ‹åˆ°luajit

è‹¥ä¸ºä¸“ç”¨æœåŠ¡å™¨ï¼šè¾“å…¥æ§åˆ¶å°ä»£ç `print(jit)`ï¼Œæ¸¸æˆè¿”å›ä¸€ä¸ªtableåˆ™ä¸ºå®‰è£…æˆåŠŸï¼ˆæ¯”å¦‚table: 0x18709a30ï¼‰

## 4.å¸è½½mod

### Windows
å°†`æ¸¸æˆç›®å½•`ä¸‹çš„ `bin64`æ–‡ä»¶å¤¹ä¸­çš„`Winmm.dll`åˆ é™¤æˆ–é‡å‘½å

### Linux/MacOS
- åˆ é™¤å®‰è£…æ¸¸æˆæ—¶è‡ªå·±åˆ›å»ºçš„`dontstarve_steam_x64`æ–‡ä»¶
- å°† `dontstarve_steam_x64_1` é‡å‘½åä¸º `dontstarve_steam_x64`
- ä¸“ç”¨æœåŠ¡å™¨åŒç†ï¼Œæ–‡ä»¶åä¸º`dontstarve_dedicated_server_nullrenderer_x64`

# MODä½œè€…å…¼å®¹

## modinfo.lua
åœ¨modinfoé‡Œé¢æ·»åŠ å…¼å®¹æ€§æ ‡è®°

å¯¹äºæ²¡æœ‰å…¼å®¹æ ‡è®°çš„MOD,å°†ä¼šæ ¹æ®`SlowTailCall`æˆ–è€…`AutoDetectEncryptedMod`é€‰é¡¹.

å¯¹å¯å‘å¼æ£€æµ‹åˆ°åŠ å¯†MODçš„ä»£ç , è‡ªåŠ¨å¯ç”¨`å †æ ˆå…¼å®¹æ€§`
```lua
luajit_compatible = true --è¡¨ç¤ºä¸ä¾èµ–å †æ ˆæ·±åº¦
--æˆ–è€…
luajit_compatible = {
  dep_tailcall = false --è¡¨ç¤ºä¸ä¾èµ–å †æ ˆæ·±åº¦
}
```

## å †æ ˆæ·±åº¦
ä¸€èˆ¬åªæœ‰åŠ å¯†modä¼šä¸¥é‡ä¾èµ–äº†å †æ ˆæ·±åº¦, æ¯”å¦‚è¯´æœ€å¸¸è§çš„ä½¿ç”¨äº†
```lua
local target_level = 2
for i =0,255 do
    local info = debug.getinfo(i, 'f')
    if info.func == Target_func then
        assert(i == target_level) -- iå˜é‡å°±æ˜¯å †æ ˆæ·±åº¦
    end
end
```
# å¦‚ä½•è°ƒè¯•æ¸¸æˆï¼š

éœ€è¦ `vscode` + `lua-debug` æ’ä»¶

## ä¸é€šè¿‡ Steam è°ƒè¯•æ¸¸æˆçš„æ–¹æ³•

åœ¨æ¸¸æˆç›®å½•/bin64 æ–‡ä»¶å¤¹ä¸­åˆ›å»º `steam_appid.txt` æ–‡ä»¶ï¼Œå†…å®¹ä¸º `322330`ã€‚

## ç›´æ¥å¯ç”¨æ¸¸æˆè°ƒè¯•

### éœ€è¦`staem_appid.txt`

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "(Windows) å¯åŠ¨æœåŠ¡å™¨(lua)",
            "type": "lua",
            "request": "launch",
            "luaexe": "${config:steam.game.root}/bin64/dontstarve_steam_x64.exe",
            "program": "",
            "arg": [],
            "env": {
                //"lua_vm_type": "game", // jit|game|5.1
                "enable_lua_debugger": "1"
            },
            "sourceFormat": "string",
            "sourceMaps": [
                [
                    "../mods/workshop-*",
                    "C:/Program Files (x86)/Steam/steamapps/workshop/content/322330/*"
                ],
                [
                    "../mods/workshop-2847908822/*",
                    "${workspaceFolder}/tests/2847908822/*"
                ],
                [   
                    "C:/Program Files (x86)/Steam/steamapps/common/Don't Starve Together/data/scripts/*",
                    "C:/Program Files (x86)/Steam/steamapps/common/Don't Starve Together/dst-scripts/scripts/*"
                ],
                [
                    "scripts/*",
                    "C:/Program Files (x86)/Steam/steamapps/common/Don't Starve Together/dst-scripts/scripts/*"
                ],
                [
                    "GameLuaInjectFramework.lua",
                    "${workspaceFolder}/src/DontStarveInjector/GameLuaInjectFramework.lua"
                ]
            ],
            "cwd": "${config:steam.game.root}/bin64",
            "luaVersion": "lua51"
        },
    ]
}

```

## ä¼ é€’è¿›ç¨‹å‚æ•° â€œ-enable_lua_debuggerâ€

è‹¥é€šè¿‡Steamå¯åŠ¨ï¼Œè¯·åœ¨æ¸¸æˆå±æ€§ > å¯åŠ¨é€‰é¡¹ä¸­æ·»åŠ ï¼šâ€œ -enable_lua_debuggerâ€

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "address": "127.0.0.1:12306",
            "name": "attach client",
            "request": "attach",
            "stopOnEntry": true,
            "type": "lua",
            "luaVersion": "luajit",
            "sourceMaps": [
                [
                    "../mods/workshop-*",
                    "E:/SteamLibrary/steamapps/workshop/content/322330/*"
                ]
            ]
        },
        {
            "address": "127.0.0.1:12307",
            "name": "attach server",
            "request": "attach",
            "stopOnEntry": true,
            "type": "lua",
            "luaVersion": "luajit",
            "sourceMaps": [
                [
                    "../mods/workshop-*",
                    "E:/SteamLibrary/steamapps/workshop/content/322330/*"
                ]
            ]
        },
        {
            "address": "127.0.0.1:12308",
            "name": "attach server cave",
            "request": "attach",
            "stopOnEntry": true,
            "type": "lua",
            "luaVersion": "luajit",
            "sourceMaps": [
                [
                    "../mods/workshop-*",
                    "E:/SteamLibrary/steamapps/workshop/content/322330/*"
                ]
            ]
        },
         {
            "name": "Launch game",
            "type": "lua",
            "request": "launch",
            "luaVersion": "luajit",
            "cwd": "${config:steam.game.root}/bin64",
            "luaexe": "${config:steam.game.root}/bin64/dontstarve_steam_x64.exe",
            "sourceMaps": [
                [
                    "../mods/workshop-*",
                    "${config:steam.game.modroot}/*"
                ],
                [   "${config:steam.game.root}/data/scripts/*",
                    "${config:steam.game.root}/dst-scripts/scripts/*" //scriptsè„šæœ¬æ–‡ä»¶å¤¹ç›®å½•
                ]
            ],
            "program": "",
            "arg": [
                "-enable_lua_debugger"
            ],
            "env": {
                "NOVSDEBUGGER": "1",
                "NOWAITDEBUGGER": "1",
            }
        },
    ], "compounds": [
        {
            "name": "Compound servers",
            "configurations": [
                "attach server",
                "attach server cave"
            ],
            "stopAll": true
        }
    ]
}
```


# æèµ äººåˆ—è¡¨

å¦‚æœé—æ¼äº†ä½ çš„æèµ ,è¯·è”ç³»æˆ‘

| å§“å | é‡‘é¢ | åŸå›          |æ¨¡ç»„id|
|------|------|--------------|-----------|
| Dv**ce   | 50RMB| å…¼å®¹MOD | [Accomplishments](https://steamcommunity.com/sharedfiles/filedetails/?id=2843097516)|
| a*t   | 20RMB| æ—  | (å…¼å®¹mod) |
| å†°*ç¾Š    | 30RMB | å…¼å®¹MOD    | [è‡ªåŠ¨å´©æºƒæ¢å¤](https://steamcommunity.com/sharedfiles/filedetails/?id=3377689002)|
| å†°*ç¾Š    | 30RMB | å…¼å®¹MOD    | [æ€§èƒ½ä¼˜åŒ–åŒ…](https://steamcommunity.com/sharedfiles/filedetails/?id=2847908822)|
| Dv**ce   | 30RMB| å¼€å‘TRACYåŠŸèƒ½ | |
| 18**30   | 20RMB| æ—  | (å…¼å®¹mod) |
| 18**30   | 20RMB| å…¼å®¹è™šæ‹Ÿæœºç¯å¢ƒ | |
| Dv**ce   | 100RMB| æ—  | (å…¼å®¹mod) |
| 18**30   | 30RMB| ä¿®å¤BUG | |
| é¢„*å¾®ç¬‘   | 100RMB | MACOS | |
| å‚¨*ä½›ä¸   | 50RMB | | |
| è½®å›**å‰‘  | 30RMB | (å…¼å®¹mod) | |
| å¤§*é›„     | 166RMB | (æ”¹è¿›åŠ å¯†å…¼å®¹æ€§)| |
| æ˜Ÿ*â˜†     | 100RMB | | |
| 18**30    | 50RMB| æ—  | |
| 33**66    | 30RMB | è¾…åŠ©å®‰è£…| |

# æèµ æ–¹å¼
![weixin_zanshang](https://github.com/user-attachments/assets/9f6485ce-5254-4207-a514-89bd02c332ce)


![å¾®ä¿¡å›¾ç‰‡_20250320092648](https://github.com/user-attachments/assets/6c754bc6-6b43-45af-bc41-fa4c502b4b3e)